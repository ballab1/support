#!/bin/bash

declare -r TOP="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"   
source "${TOP}/libs/loadLibraries.sh"

cd "$TOP"
declare branch="$(git branch | grep '* ' | awk '{print $2}')"
[ "$branch" = 'master' ] || branch=latest
cd "$TOP"/versions
git checkout "$branch"
git pull
cd ..

declare -a modules
declare -a OSes
mapfile -t OSes < <(sed '/^[[:blank:]]*#/d;s/[[:blank:]]*#.*//' container.os)
[ "${CONTAINER_OS:-}" ] && OSes=( $CONTAINER_OS )

declare cbf_version
[ "${CBF_VERSION:-}" ] && cbf_version="$CBF_VERSION"

for containerOS in "${OSes[@]}"; do
    [ ${containerOS:-} ] || continue
    [ -e "${TOP}/versions/$containerOS" ] || continue

    source "${TOP}/versions/$containerOS" 
    export CONTAINER_OS="$containerOS"/
    
    [ $# -gt 0 ] && modules=( "$@" )
    [ "${cbf_version:-}" ] && CBF_VERSION="$cbf_version"
    build.allContainers "${modules[@]}"
done